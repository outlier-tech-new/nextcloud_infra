# Daily Journal – 2025-11-27

## Summary
- Brought up the Nextcloud stack on `nas01` with Docker Compose; resolved race conditions and environment handling in `scripts/05_nextcloud_stack_up.sh`. Committed to automation-first deployment (no web UI configuration) per ADR 0004.
- Implemented static bonding (`balance-xor`) on `enp1s0`/`enp2s0` with DHCP reservations; verified on `ubnsvrnas001`.
- Registered internal DNS records (`nas01`, `nas02`, `nextcloud-01`, `nextcloud-active`, etc.) in `outliertechnology.co.uk` and `lan.outliertechnology.co.uk`.
- Installed zrepl via the official `.deb` (repo DNS still offline); service disabled pending config.
- Enabled SMART monitoring (`smartmontools`) and ensured Nextcloud env templates handle trusted domains.
- Resolved Nextcloud “untrusted domain” and HTTPS redirect issues; verified login via `http://nas01.outliertechnology.co.uk:8080`.

## Detailed Notes

### Networking / DNS
- Bonding active on `nas01` ports 1+2 → `bond0` at `192.168.1.24`; DHCP reservation tied to MAC `78:55:36:03:ef:8e`.
- Keeplink switch trunks configured statically (ports 1/2 for office, 3/4 for house).
- DNS zones updated:
  - `nas01`, `nas02`, `nextcloud-01`, `nextcloud-02`, `nextcloud-active` (CNAME), `cloud`, etc.
  - Reverse entries pending.
- `docs/network-plan.md` and `docs/dns-plan.md` capture bonding strategy and record sets.

### Nextcloud
- `scripts/04_nextcloud_compose_setup.sh`/`05_nextcloud_stack_up.sh` run cleanly; `occ status` now executed as UID 33.
- `trusted_domains` set via `occ config:system:set` (includes `nas01`, `nas02`, `nextcloud`, `192.168.1.24`, `nas01:8080`).
- `overwriteprotocol` and `overwrite.cli.url` forced to `http`/`http://nas01:8080` pending reverse proxy; direct edit applied to `/srv/nextcloud/app/config/config.php`.
- Admin account confirmed (`occ user:info admin`), but password reset loops traced to HTTPS redirect. Login now succeeds.
- Web installer not yet executed; consider headless `occ maintenance:install` if reinitializing.

### System Hardening
- `smartmontools` installed; `smartd` configured for NVMe drives (mail to admin@outliertechnology.co.uk).
- Cron scrub and Redis sysctl pending.
- `docs/hardening-checklist.md` updated to mention headless install option.

### zrepl
- Installed via `zrepl_0.6.1-2_amd64.deb`; service disabled due to missing config.
- `/etc/zrepl/zrepl.yml` still template; needs hostnames/datasets before enabling.

## Outstanding Tasks (Tomorrow)
- Finish Nextcloud initial configuration (either via installer or `occ maintenance:install`):
  - Set admin credentials, database, finalize apps.
  - Configure background jobs (`cron`), email settings, install required apps.
- Apply remaining hardening checklist items:
  - Run `apt upgrade`, enable unattended upgrades.
  - Add Redis `vm.overcommit_memory = 1`, optional inotify tweak.
  - Schedule monthly scrub (`/etc/cron.d/zpool-scrub`).
  - Verify bond persists after reboot on house NAS; configure there.
- Populate `/etc/zrepl/zrepl.yml`, run `scripts/07_configure_zrepl.sh`, exchange SSH keys.
- Archive configs (`~/exports` tarballs) including `/srv/nextcloud/app/config/config.php`, `/etc/zrepl`, `/etc/netplan`.
- Begin prepping second NAS per `docs/cloning-plan.md`.

## References
- `docs/network-plan.md`
- `docs/dns-plan.md`
- `docs/hardening-checklist.md`
- `docs/cloning-plan.md`
- `scripts/04_nextcloud_compose_setup.sh`
- `scripts/05_nextcloud_stack_up.sh`

